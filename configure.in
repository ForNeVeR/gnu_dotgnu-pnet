dnl Process this file with autoconf to produce a configure script.
AC_INIT(include/il_opcodes.h)

dnl Determine the build, host, and target system types.
AC_CANONICAL_SYSTEM

dnl Initialize automake.
AM_INIT_AUTOMAKE(pnet, 0.3.2)
AM_CONFIG_HEADER(include/il_config.h)

dnl Checks for programs.
AC_PROG_AWK
AC_PROG_CC
AC_PROG_INSTALL
AC_PROG_LN_S
AC_PROG_MAKE_SET
AC_PROG_RANLIB
AC_PROG_YACC
AM_PROG_LEX
AC_PATH_PROG(TREECC, treecc,, ${prefix}/bin:$PATH)
if test -z "$TREECC" ; then
    echo "treecc is required to build and can be obtained from"
    echo "http://www.southern-storm.com.au"
    exit 1
fi

dnl This code was borrowed from "libgc" to test for the correct
dnl thread package to use, and to notify the garbage collector's
dnl "gc.h" file of the correct features to enable.  See the
dnl "libgc/configure.in" file for Copyright and other information.

AC_MSG_CHECKING([for threads package to use])
AC_ARG_ENABLE(threads, [  --enable-threads=TYPE   choose threading package],
  THREADS=$enableval,
  [ AC_MSG_CHECKING([for thread model used by GCC])
    THREADS=`$CC -v 2>&1 | sed -n 's/^Thread model: //p'`
    if test -z "$THREADS"; then
      THREADS=no
    fi
    AC_MSG_RESULT([$THREADS])])

THREADLIBS=
case "$THREADS" in
 no | none | single)
    THREADS=none
    ;;
 posix | pthreads)
    THREADS=posix
    THREADLIBS=-lpthread
    case "$host" in
     x86-*-linux* | ia64-*-linux* | i586-*-linux* | i686-*-linux*)
		AC_DEFINE(GC_LINUX_THREADS)
		AC_DEFINE(_REENTRANT)
	;;
     *-*-linux*)
		AC_DEFINE(GC_LINUX_THREADS)
		AC_DEFINE(_REENTRANT)
	;;
     *-*-hpux*)
		AC_MSG_WARN("Only HP/UX 11 threads are supported.")
		AC_DEFINE(GC_HPUX_THREADS)
		THREADLIBS="-lpthread -lrt"
	;;
     *-*-freebsd*)
		AC_MSG_WARN("FreeBSD does not yet fully support threads with Boehm GC.")
		AC_DEFINE(FREEBSD_THREADS)
		INCLUDES="$INCLUDES -pthread"
		THREADLIBS=-pthread
      	;;
     *-*-solaris*)
		AC_DEFINE(GC_SOLARIS_THREADS)
		AC_DEFINE(GC_SOLARIS_PTHREADS)
	;;
     *-*-irix*)
		AC_DEFINE(GC_IRIX_THREADS)
	;;
    esac
    ;;
 decosf1 | irix | mach | os2 | solaris | win32 | dce | vxworks)
    	AC_MSG_ERROR(thread package $THREADS not yet supported)
    ;;
 *)
    	AC_MSG_ERROR($THREADS is an unknown thread package)
    ;;
esac

dnl End of borrowed code.

dnl Checks for libraries.
AC_SUBST(REGEXLIBS)
AC_CHECK_LIB(m, sin)
AC_CHECK_LIB(dl, dlopen)
AC_CHECK_LIB(regex, regcomp, [REGEXLIBS=-lregex], [])

dnl Collect up the libraries that we need for GNU readline.
AC_SUBST(READLINELIBS)
READLINELIBS=""
AC_CHECK_LIB(termcap, tgoto, [READLINELIBS="$READLINELIBS -ltermcap"], [])
AC_CHECK_LIB(readline, readline, [AC_DEFINE(HAVE_LIBREADLINE)
READLINELIBS="-lreadline $READLINELIBS"], [], $READLINELIBS)
AC_CHECK_LIB(history, add_history, [AC_DEFINE(HAVE_LIBHISTORY)
READLINELIBS="-lhistory $READLINELIBS"], [])

dnl Checks for header files.
AC_HEADER_STDC
AC_HEADER_SYS_WAIT
AC_HEADER_TIME
AC_CHECK_HEADERS(string.h strings.h memory.h stdlib.h math.h fcntl.h)
AC_CHECK_HEADERS(stdarg.h varargs.h sys/mman.h unistd.h sys/stat.h)
AC_CHECK_HEADERS(sys/time.h sys/types.h regex.h dlfcn.h ieeefp.h)
AC_CHECK_HEADERS(readline/readline.h readline/history.h)

dnl Checks for typedefs, structures, and compiler characteristics.
AC_C_CONST
AC_CHECK_SIZEOF(int, 4)
AC_CHECK_SIZEOF(long, 4)
AC_CHECK_SIZEOF(long long, 8)
AC_CHECK_SIZEOF(float, 4)
AC_CHECK_SIZEOF(double, 8)
AC_CHECK_SIZEOF(long double, 12)
AC_CHECK_SIZEOF(void *, 4)

dnl Check to see if we are using gcc or not.
AM_CONDITIONAL(USINGGCC, test x$GCC = xyes)

dnl Checks for library functions.
AC_FUNC_MEMCMP
AC_CHECK_FUNCS(memset memcmp memchr memcpy memmove bcopy bzero bcmp)
AC_CHECK_FUNCS(isnan isinf finite fmod strtod mmap munmap getpagesize)
AC_CHECK_FUNCS(stat vfprintf waitpid wait fork execv open gettimeofday)
AC_CHECK_FUNCS(getpid qsort regcomp re_comp unlink remove getcwd getwd)
AC_CHECK_FUNCS(get_current_dir_name dlopen strerror fcntl ftruncate)
AC_CHECK_FUNCS(acos asin atan atan2 ceil cos cosh exp floor remainder)
AC_CHECK_FUNCS(log log10 pow rint sin sinh sqrt tan tanh)
AC_FUNC_ALLOCA

dnl Configure libffi and libgc
AC_CONFIG_SUBDIRS(libffi libgc)

dnl Add the thread libraries to the end of the link line.
LIBS="$LIBS $THREADLIBS"

AC_OUTPUT([
Makefile
include/Makefile
support/Makefile
image/Makefile
dumpasm/Makefile
engine/Makefile
ilasm/Makefile
ildasm/Makefile
ilalink/Makefile
ilsize/Makefile
ilnative/Makefile
ilfind/Makefile
ildiff/Makefile
codegen/Makefile
cscc/Makefile
cscc/common/Makefile
cscc/csharp/Makefile
resgen/Makefile
ildb/Makefile
csdoc/Makefile
csant/Makefile
samples/Makefile
doc/Makefile
tests/Makefile])
