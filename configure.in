dnl Process this file with autoconf to produce a configure script.
AC_INIT(include/stdarg.h)

dnl Force the configure script to think that the target is "cli".
dnl The full name is "cli-unknown-none": "unknown-none" means that the
dnl resulting binaries will work for all vendors and operating systems
dnl that have cli's, which is what we want to happen.
if test "x$as_expr" = "x" ; then
	dnl Old-style autoconf where --host == --build
	target=cli-unknown
	target_alias=cli-unknown
	cross_compiling=yes
	ac_cv_prog_cc_cross=yes
else
	dnl New-style autoconf where --host == --target
	host=cli-unknown-none
	host_alias=cli-unknown
	target=cli-unknown-none
	target_alias=cli-unknown
	ac_tool_prefix=cli-unknown-
	ac_cv_host=$host
	ac_cv_target=$target
	cross_compiling=yes
	ac_cv_prog_cc_cross=yes
fi

dnl Determine the build, host, and target system types.
AC_CANONICAL_SYSTEM

dnl Initialize automake.
AM_INIT_AUTOMAKE(pnetC, 0.5.13)
AM_MAINTAINER_MODE

dnl The --with-pnet option can be used to specify the location of
dnl Portable.NET, so that we know where to get the C compiler, etc.
dnl The default location is assumed to be "../pnet".
AC_SUBST(PNET_PATH)
AC_ARG_WITH(pnet,
[  --with-pnet=DIR         specify the location of Portable.NET],
[
	if test -n "$withval"; then
		case "$withval" in
		  ../*) PNET_PATH="`pwd`/$withval"
		        PNET_CHECK_PATH="$withval" ;;
		     *) PNET_PATH="$withval"
			    PNET_CHECK_PATH="$withval" ;;
		esac
	else
		PNET_PATH="`pwd`/../pnet"
		PNET_CHECK_PATH="../pnet"
	fi
],
[
	PNET_PATH="`pwd`/../pnet"
	PNET_CHECK_PATH="../pnet"
])

dnl The --with-pnetlib option can be used to specify the location of
dnl the Portable.NET C# library, so that we know where to get the
dnl mscorlib.dll assembly to use with "ilrun".  The default location
dnl is assumed to be "../pnetlib".
AC_SUBST(PNETLIB_PATH)
AC_ARG_WITH(pnetlib,
[  --with-pnetlib=DIR      specify the location of pnetlib],
[
	if test -n "$withval"; then
		case "$withval" in
		  ../*) PNETLIB_PATH="`pwd`/$withval"
		        PNETLIB_CHECK_PATH="$withval" ;;
		     *) PNETLIB_PATH="$withval"
			    PNETLIB_CHECK_PATH="$withval" ;;
		esac
	else
		PNETLIB_PATH="`pwd`/../pnetlib"
		PNETLIB_CHECK_PATH="../pnetlib"
	fi
],
[
	PNETLIB_PATH="`pwd`/../pnetlib"
	PNETLIB_CHECK_PATH="../pnetlib"
])

dnl The --with-32bit option can be used to force a 32-bit only build.
AC_SUBST(LIBRARY_SUFFIX)
AC_ARG_WITH(32bit,
[  --with-32bit            specify a 32-bit only build],
[
	EXTRA_CFLAGS="-m32bit-only"
	LIBRARY_SUFFIX="32"
],
[
	EXTRA_CFLAGS=""
	LIBRARY_SUFFIX="64"
])

dnl Find the location of the "cscc" compiler.
AC_PATH_PROG(CSCC, cscc,, ${PNET_CHECK_PATH}/cscc:${prefix}/bin:$PATH)
if test -z "$CSCC" ; then
	AC_MSG_ERROR([Portable.NET's C compiler, cscc, is required to build.])
fi
case "$CSCC" in
	../*) CSCC_REAL="${PNET_PATH}/cscc/cscc" ;;
	   *) CSCC_REAL="$CSCC" ;;
esac

dnl Find the location of the "ilrun" runtime engine.
AC_PATH_PROG(ILRUN, ilrun,, ${PNET_PATH}/engine:${prefix}/bin:$PATH)

dnl Determine additional flags that we need to force "cscc" to act sane.
dnl We use slightly different paths than the final to prevent strange
dnl problems with spaces in pathnames under Cygwin.
CFLAGS="-x c $EXTRA_CFLAGS"
if test -x "$PNET_CHECK_PATH/cscc/cscc-c-s" ; then
	CFLAGS="$CFLAGS -fplugin-c-path=$PNET_CHECK_PATH/cscc/cscc-c-s"
fi
if test -x "$PNET_CHECK_PATH/cscc/cscc-cs" ; then
	CFLAGS="$CFLAGS -fplugin-cs-path=$PNET_CHECK_PATH/cscc/cscc-cs"
fi
if test -f "$PNETLIB_CHECK_PATH/csupport/OpenSystem.C.dll" ; then
	CFLAGS="$CFLAGS -L$PNETLIB_CHECK_PATH/csupport"
fi
if test -f "$PNETLIB_CHECK_PATH/runtime/mscorlib.dll" ; then
	CFLAGS="$CFLAGS -L$PNETLIB_CHECK_PATH/runtime"
fi

dnl Modify the environment to force autoconf/automake to use "cscc"
dnl instead of the system's default C compiler.  We use the flag
dnl "-fcross-compile-check" to force cscc to generate a program that
dnl will compile successfully, but won't run.  This fools configure
dnl into believing that cscc is a cross-compiler, which it is.
CC="$CSCC"
CPPFLAGS="-nostdinc"
LDFLAGS="-fcross-compile-check -nostdlib"

dnl Force the configure script to believe that we are a cross-compiler.
dnl Configure may still try to run the binary anyway, in which case
dnl the "-fcross-compile-check" flag should catch us.
cross_compiling=yes

dnl Checks for programs.
AC_PROG_AWK
AC_PROG_CC
AC_PROG_INSTALL
AC_PROG_LN_S
AC_PROG_MAKE_SET
AC_PROG_RANLIB

dnl Remove the "-fcross-compile-check" flag from "LDFLAGS".
LDFLAGS="-nostdlib"

dnl Check for file extensions.
AC_EXEEXT
AC_OBJEXT

dnl Set up the final CC, CSCC, and CFLAGS values for the Makefile's.
CC="\"$CSCC_REAL\""
CSCC="\"$CSCC_REAL\""
CFLAGS="-x c $EXTRA_CFLAGS"
if test -x "$PNET_PATH/cscc/cscc-c-s" ; then
	CFLAGS="$CFLAGS \"-fplugin-c-path=$PNET_PATH/cscc/cscc-c-s\""
fi
if test -x "$PNET_PATH/cscc/cscc-cs" ; then
	CFLAGS="$CFLAGS \"-fplugin-cs-path=$PNET_PATH/cscc/cscc-cs\""
fi
if test -f "$PNETLIB_PATH/csupport/OpenSystem.C.dll" ; then
	CFLAGS="$CFLAGS \"-L$PNETLIB_PATH/csupport\""
fi
if test -f "$PNETLIB_PATH/runtime/mscorlib.dll" ; then
	CFLAGS="$CFLAGS \"-L$PNETLIB_PATH/runtime\""
fi

AC_OUTPUT([
Makefile
include/Makefile
include/bits/Makefile
include/gnu/Makefile
include/sys/Makefile
libc/Makefile
libc/ctype/Makefile
libc/dirent/Makefile
libc/malloc/Makefile
libc/misc/Makefile
libc/pthread/Makefile
libc/pwd/Makefile
libc/stdio/Makefile
libc/stdlib/Makefile
libc/string/Makefile
libc/time/Makefile
libc/unistd/Makefile
libm/Makefile
samples/Makefile
samples/ilrun.sh])

chmod +x "${srcdir}/samples/ilrun.sh"
